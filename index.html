<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rell Makalah AI - Generator Makalah Otomatis Online Gratis</title>
    <meta name="google-site-verification" content="hc7xIt5KLo-DjPjK1E7aFJjOxEsPrnBbSU9hIByzmZc" /><!-- Deskripsi meta untuk SEO -->
    <meta name="description" content="Rell Makalah AI adalah generator makalah otomatis yang membantu Anda menyusun draf makalah dengan cepat berdasarkan judul dan kerangka.">
    <!-- Google Fonts untuk tampilan futuristik -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Space+Mono&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur variabel CSS untuk warna dan font */
        :root {
            --primary-blue: #00bcd4; /* Cyan terang */
            --secondary-purple: #8e24aa; /* Ungu */
            --dark-bg: #1a1a2e; /* Latar belakang gelap */
            --light-text: #e0e0e0; /* Teks terang */
            --accent-green: #00e676; /* Hijau aksen */
            --accent-red: #ff1744; /* Merah aksen */
            --gradient-1: linear-gradient(90deg, #00bcd4, #8e24aa);
            --gradient-2: linear-gradient(90deg, #00e676, #00bcd4);
            --font-orbitron: 'Orbitron', sans-serif;
            --font-space-mono: 'Space Mono', monospace;
            --font-inter: 'Inter', sans-serif;
        }

        /* Styling dasar body untuk tampilan full-size dan futuristik */
        body {
            font-family: var(--font-inter);
            background: var(--dark-bg); /* Latar belakang gelap */
            background-image: radial-gradient(circle at top left, rgba(0, 188, 212, 0.15) 0%, transparent 50%),
                              radial-gradient(circle at bottom right, rgba(142, 36, 170, 0.15) 0%, transparent 50%);
            color: var(--light-text); /* Warna teks terang */
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 0; /* Hapus padding dari body untuk mobile */
            margin: 0; /* Pastikan tidak ada margin default */
            box-sizing: border-box;
            overflow-x: hidden; /* Mencegah scroll horizontal */
        }

        /* Container utama yang responsif penuh */
        .container {
            background-color: rgba(26, 26, 46, 0.8); /* Latar belakang semi-transparan */
            backdrop-filter: blur(8px); /* Efek blur pada latar belakang */
            padding: 2rem 1rem; /* Padding vertikal 2rem, horizontal 1rem untuk mobile */
            border-radius: 0; /* Hapus border-radius di mobile agar full-width */
            box-shadow: none; /* Hapus shadow di mobile */
            width: 100%; /* Selalu 100% lebar */
            max-width: 900px; /* Batasi lebar maksimum untuk desktop */
            display: flex;
            flex-direction: column;
            gap: 1.8rem; /* Jarak antar elemen lebih besar */
            border: none; /* Hapus border di mobile */
        }

        /* Media query untuk desktop (layar > 768px) */
        @media (min-width: 768px) {
            body {
                padding: 2rem; /* Tambahkan padding kembali untuk desktop */
            }
            .container {
                padding: 3rem; /* Padding standar untuk desktop */
                border-radius: 1.5rem; /* Terapkan border-radius untuk desktop */
                box-shadow: 0 0 30px rgba(0, 188, 212, 0.3), 0 0 60px rgba(142, 36, 170, 0.2); /* Terapkan shadow untuk desktop */
                border: 1px solid rgba(0, 188, 212, 0.3); /* Terapkan border untuk desktop */
            }
        }

        h1 {
            font-family: var(--font-orbitron); /* Font futuristik untuk judul utama */
            font-size: 3.5rem; /* Ukuran lebih besar */
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            /* Efek gradien teks */
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; /* Fallback */
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.5), 0 0 20px rgba(142, 36, 170, 0.3);
        }

        .owner-text {
            font-family: var(--font-space-mono); /* Font keren untuk teks owner */
            font-size: 0.9rem; /* Ukuran sedikit lebih besar */
            color: var(--light-text);
            text-align: center;
            opacity: 0.6; /* Opacity lebih tinggi agar lebih terlihat */
            margin-top: -0.5rem; /* Naikkan sedikit agar dekat dengan judul */
            margin-bottom: 1.5rem;
            text-shadow: 0 0 5px rgba(0, 188, 212, 0.2);
        }

        p {
            font-size: 1.1rem; /* Ukuran paragraf lebih besar */
            color: var(--light-text);
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem; /* Jarak label lebih besar */
            font-weight: 600;
            color: var(--light-text);
            font-size: 1.1rem; /* Ukuran label lebih besar */
        }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="email"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 1rem; /* Padding input lebih besar */
            border: 1px solid rgba(0, 188, 212, 0.4); /* Border dengan warna aksen */
            border-radius: 0.75rem; /* Sudut lebih membulat */
            font-size: 1.1rem; /* Ukuran font input lebih besar */
            background-color: rgba(0, 0, 0, 0.3); /* Latar belakang input gelap transparan */
            color: var(--light-text);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input[type="text"]:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(0, 188, 212, 0.4); /* Efek glow saat fokus */
        }
        .form-group textarea {
            min-height: 150px; /* Tinggi minimum textarea */
        }

        .btn-primary, .btn-secondary {
            background: var(--gradient-1); /* Gradien untuk tombol utama */
            color: #ffffff;
            font-weight: 700;
            padding: 1rem 2.5rem; /* Padding tombol lebih besar */
            border: none;
            border-radius: 0.75rem;
            font-size: 1.2rem; /* Ukuran font tombol lebih besar */
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 188, 212, 0.4); /* Efek shadow/glow */
            width: fit-content;
            align-self: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1rem; /* Jarak antar tombol */
        }
        .btn-primary:hover {
            background: var(--gradient-2); /* Gradien berbeda saat hover */
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 230, 118, 0.5); /* Efek glow lebih kuat */
        }
        .btn-primary:disabled, .btn-secondary:disabled {
            background: #4a4a68; /* Warna abu-abu saat dinonaktifkan */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .btn-secondary {
            background: #4a4a68; /* Warna abu-abu untuk tombol sekunder */
            box-shadow: 0 5px 15px rgba(74, 74, 104, 0.4);
        }
        .btn-secondary:hover {
            background: #6a6a8a;
            box-shadow: 0 8px 20px rgba(106, 106, 138, 0.5);
        }

        .loading-indicator {
            display: none;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--primary-blue);
            font-size: 1.1rem;
            font-weight: 600;
        }
        .loading-indicator.active {
            display: block;
        }
        .result-area {
            background-color: rgba(0, 0, 0, 0.3); /* Latar belakang hasil gelap transparan */
            border: 1px solid rgba(0, 188, 212, 0.3);
            border-radius: 0.75rem;
            padding: 2rem; /* Padding lebih besar */
            min-height: 250px; /* Tinggi minimum lebih besar */
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--light-text);
            font-size: 1.1rem; /* Ukuran font hasil lebih besar */
            line-height: 1.8; /* Line height lebih lega */
            margin-top: 1.8rem;
            box-shadow: inset 0 0 10px rgba(0, 188, 212, 0.1);
        }
        .result-area h2 {
            font-size: 2rem; /* Ukuran judul hasil lebih besar */
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--primary-blue);
            text-shadow: 0 0 8px rgba(0, 188, 212, 0.4);
        }
        .warning-message {
            background-color: rgba(255, 235, 179, 0.2); /* Kuning sangat terang transparan */
            border-left: 4px solid #ffc107; /* Kuning oranye */
            color: #ffeb3b; /* Teks kuning terang */
            padding: 1.2rem; /* Padding lebih besar */
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.2);
        }
        .copy-button {
            background: var(--gradient-2); /* Gradien untuk tombol salin */
            color: #ffffff;
            font-weight: 700;
            padding: 0.9rem 2rem; /* Padding tombol lebih besar */
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
            width: fit-content;
            align-self: flex-end;
            margin-top: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 230, 118, 0.4);
        }
        .copy-button:hover {
            background: var(--gradient-1);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 188, 212, 0.5);
        }
        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--accent-green);
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 1000;
            font-size: 1.2rem;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.5);
            border: 1px solid var(--accent-green);
        }

        /* Styling untuk kerangka yang dihasilkan */
        #generatedOutlineContainer {
            background-color: rgba(0, 188, 212, 0.1); /* Latar belakang biru muda transparan */
            border: 1px solid rgba(0, 188, 212, 0.5); /* Border biru */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--light-text); /* Warna teks terang */
            box-shadow: inset 0 0 10px rgba(0, 188, 212, 0.1);
        }
        #generatedOutlineContainer h3 {
            font-size: 1.6rem; /* Ukuran lebih besar */
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-blue);
            text-shadow: 0 0 5px rgba(0, 188, 212, 0.3);
        }
        #outlineContent ul {
            list-style-type: decimal;
            margin-left: 1.8rem; /* Margin lebih besar */
            font-size: 1rem;
        }
        #outlineContent ul ul {
            list-style-type: lower-alpha;
            margin-left: 1.8rem;
        }
        #outlineContent ul ul ul {
            list-style-type: lower-roman;
            margin-left: 1.8rem;
        }
        #outlineContent li {
            margin-bottom: 0.5rem; /* Jarak antar list item lebih besar */
        }

        /* Styling untuk Bab */
        .bab-heading {
            font-size: 2.8rem; /* Ukuran sangat besar untuk BAB */
            font-weight: 800;
            color: var(--accent-green); /* Warna aksen hijau */
            margin-top: 3.5rem; /* Margin lebih besar */
            margin-bottom: 2rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(0, 230, 118, 0.6);
        }

        /* Styling untuk Daftar Isi, Catatan Kaki, Daftar Pustaka */
        .section-heading {
            font-size: 2.2rem; /* Ukuran lebih besar */
            font-weight: 700;
            color: var(--primary-blue);
            margin-top: 2.5rem;
            margin-bottom: 1.2rem;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.4);
        }
        .list-unstyled {
            list-style: none;
            padding-left: 0;
        }
        .footnote-ref {
            vertical-align: super;
            font-size: 0.8em; /* Ukuran sedikit lebih besar */
            color: var(--accent-green); /* Warna aksen hijau */
            text-decoration: none;
            margin-left: 3px;
            font-weight: 700;
        }
        .footnote-ref:hover {
            text-decoration: underline;
        }

        /* Styling untuk Auth Section */
        #authSection {
            background-color: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(0, 188, 212, 0.2);
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #authSection h3 {
            font-size: 1.8rem;
            font-family: var(--font-orbitron);
            color: var(--primary-blue);
            text-align: center;
            margin-bottom: 1rem;
        }
        #authStatus {
            text-align: center;
            font-size: 1.1rem;
            color: var(--accent-green);
        }
        #authStatus.logged-out {
            color: var(--accent-red);
        }
        .auth-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap; /* Wrap buttons on small screens */
        }
        .auth-buttons .btn-primary, .auth-buttons .btn-secondary {
            margin-top: 0.5rem; /* Reduce margin top for auth buttons */
        }
        /* Styling untuk tombol premium */
        .btn-premium {
            background: linear-gradient(90deg, #ffc107, #ff8f00); /* Gradien emas/oranye */
            color: #1a1a2e; /* Teks gelap */
            font-weight: 700;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.5);
            width: fit-content;
            align-self: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1rem;
        }
        .btn-premium:hover {
            background: linear-gradient(90deg, #ffeb3b, #ffc107);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(255, 235, 59, 0.6);
        }
        .btn-premium:disabled {
            background: #6a6a8a;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        /* Styling untuk opsi select yang dinonaktifkan */
        option[disabled] {
            color: #888;
            font-style: italic;
        }
        /* Styling untuk custom word count input */
        #customWordCountContainer {
            display: none; /* Sembunyikan secara default */
            margin-top: 1rem;
            text-align: center;
        }
        #customWordCountContainer label {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: var(--light-text);
        }
        #customWordCountInput {
            max-width: 200px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center mb-0">
            Rell Makalah AI
        </h1>
        <p class="owner-text">
            own by Ver3l4U
        </p>

        <!-- Bagian Autentikasi -->
        <div id="authSection">
            <h3 id="authTitle">Masuk / Daftar</h3>
            <div id="authStatus" class="logged-out">Anda belum masuk.</div>
            <div id="authForm" class="flex flex-col gap-4">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="Minimal 6 karakter">
                </div>
                <div class="auth-buttons">
                    <button id="loginBtn" class="btn-primary">Masuk</button>
                    <button id="registerBtn" class="btn-secondary">Daftar</button>
                    <button id="logoutBtn" class="btn-secondary hidden">Keluar</button>
                </div>
                <button id="upgradePremiumBtn" class="btn-premium hidden">Upgrade ke Premium!</button>
            </div>
        </div>

        <p class="text-md text-gray-600 text-center mb-6">
            Masukkan judul dan kerangka makalah Anda (opsional), lalu biarkan AI membantu menyusun draf awal.
        </p>

        <div class="warning-message">
            **Penting:** Makalah yang dihasilkan adalah draf awal. Anda **wajib** melakukan riset mendalam,
            memeriksa fakta, menambahkan sitasi yang akurat, dan melakukan revisi menyeluruh
            sebelum menggunakan atau menyerahkan makalah ini.
        </div>

        <div class="form-group mt-6">
            <label for="judulMakalah">Judul Makalah:</label>
            <input type="text" id="judulMakalah" placeholder="Contoh: Dampak Teknologi AI terhadap Masa Depan Pendidikan">
        </div>

        <div class="form-group">
            <label for="kerangkaMakalah">Kerangka Makalah / Poin Utama (opsional, pisahkan dengan baris baru):</label>
            <textarea id="kerangkaMakalah" rows="8" placeholder="Contoh:
1. Pendahuluan
   a. Latar Belakang
   b. Rumusan Masalah
   c. Tujuan Penulisan
2. Tinjauan Pustaka
   a. Definisi AI dalam Pendidikan
   b. Teori Pembelajaran Digital
3. Pembahasan
   a. Integrasi AI dalam Kurikulum
   b. Tantangan Implementasi AI
   c. Peluang AI untuk Personalisasi Pembelajaran
4. Kesimpulan
   a. Ringkasan Temuan
   b. Saran dan Implikasi"></textarea>
        </div>

        <div class="form-group">
            <label for="panjangMakalah">Panjang Makalah (opsional):</label>
            <select id="panjangMakalah">
                <option value="pendek">Pendek (sekitar 500 kata)</option>
                <option value="sedang" selected>Sedang (sekitar 1000 kata)</option>
                <option value="panjang">Panjang (sekitar 1500 kata)</option>
                <option value="4000_kata">4000 kata</option>
                <option value="4250_kata">4250 kata</option>
                <option value="5000_kata" disabled>5000 kata (Premium)</option>
                <option value="custom_premium" disabled>Kustom (5000-12000 kata, Premium)</option>
            </select>
        </div>

        <div id="customWordCountContainer" class="form-group">
            <label for="customWordCountInput">Jumlah Kata Kustom (5000 - 12000):</label>
            <input type="number" id="customWordCountInput" min="5000" max="12000" placeholder="Masukkan jumlah kata">
        </div>

        <button id="generateBtn" class="btn-primary">
            Buat Makalah
        </button>

        <div id="loadingIndicator" class="loading-indicator">
            Memuat... Mohon tunggu sebentar.
        </div>

        <div class="result-area hidden" id="resultArea">
            <h2>Draf Makalah Anda:</h2>
            <div id="generatedOutlineContainer" class="hidden">
                <h3>Kerangka Makalah yang Dihasilkan:</h3>
                <div id="outlineContent" class="text-gray-700">
                    <!-- Outline will go here -->
                </div>
            </div>
            <div id="makalahContent" class="text-gray-800">
                <!-- Konten makalah yang dihasilkan AI akan muncul di sini -->
            </div>
            <button id="copyContentBtn" class="copy-button">
                Salin Konten
            </button>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Global Firebase instances
        let app, auth, db, analytics;
        let userId = null; // Untuk menyimpan UID pengguna yang sedang login
        let isUserPremium = false; // Status premium pengguna

        // Deklarasikan appId secara global di dalam cakupan modul
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Prioritaskan __firebase_config dari lingkungan Canvas jika tersedia.
        // Jika tidak, gunakan konfigurasi yang di-hardcode (untuk GitHub Pages).
        let firebaseConfig = {};
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Firebase Init: Menggunakan konfigurasi dari Canvas.");
            } catch (e) {
                console.error("Firebase Init: Error parsing __firebase_config:", e);
                console.log("Firebase Init: Gagal parsing konfigurasi Canvas, menggunakan konfigurasi hardcode.");
                firebaseConfig = {
                    apiKey: "AIzaSyA-LE_wG_0WLmvOQ51rME4t8zw-WWEi914", // GANTI DENGAN KUNCI API FIREBASE ANDA DARI KONSOL FIREBASE
                    authDomain: "rell-makalah-ai-project-89a29.firebaseapp.com", // GANTI DENGAN AUTH DOMAIN ANDA
                    projectId: "rell-makalah-ai-project-89a29", // GANTI DENGAN PROJECT ID ANDA
                    storageBucket: "rell-makalah-ai-project-89a29.firebasestorage.app",
                    messagingSenderId: "862112040534",
                    appId: "1:862112040534:web:6bec7aea2c7ec63f3d5df7",
                    measurementId: "G-SJK5Q727K4"
                };
            }
        } else {
            // Gunakan konfigurasi hardcode jika __firebase_config tidak didefinisikan (misal di GitHub Pages)
            console.log("Firebase Init: __firebase_config tidak ditemukan, menggunakan konfigurasi hardcode.");
            firebaseConfig = {
                apiKey: "AIzaSyA-LE_wG_0WLmvOQ51rME4t8zw-WWEi914", // GANTI DENGAN KUNCI API FIREBASE ANDA DARI KONSOL FIREBASE
                authDomain: "rell-makalah-ai-project-89a29.firebaseapp.com", // GANTI DENGAN AUTH DOMAIN ANDA
                projectId: "rell-makalah-ai-project-89a29", // GANTI DENGAN PROJECT ID ANDA
                storageBucket: "rell-makalah-ai-project-89a29.firebasestorage.app",
                messagingSenderId: "862112040534",
                appId: "1:862112040534:web:6bec7aea2c7ec63f3d5df7",
                measurementId: "G-SJK5Q727K4"
            };
        }

        // Fungsi untuk menampilkan pesan temporer
        function showMessage(message, duration = 2000) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // Fungsi untuk memperbarui status UI premium
        function updatePremiumUI(currentUser) { // Menerima objek user sebagai parameter
            const panjangMakalahSelect = document.getElementById('panjangMakalah');
            const customWordCountContainer = document.getElementById('customWordCountContainer');
            const customWordCountInput = document.getElementById('customWordCountInput');
            const upgradePremiumBtn = document.getElementById('upgradePremiumBtn');
            const authStatus = document.getElementById('authStatus');

            // Opsi yang selalu gratis
            const freeOptions = ['pendek', 'sedang', 'panjang', '4000_kata', '4250_kata'];
            // Opsi yang premium
            const premiumOptionsValues = ['5000_kata', 'custom_premium'];

            panjangMakalahSelect.querySelectorAll('option').forEach(option => {
                if (freeOptions.includes(option.value)) {
                    option.disabled = false;
                    option.textContent = option.textContent.replace(' (Premium)', '');
                } else if (premiumOptionsValues.includes(option.value)) {
                    if (isUserPremium) {
                        option.disabled = false;
                        option.textContent = option.textContent.replace(' (Premium)', '');
                    } else {
                        option.disabled = true;
                        if (!option.textContent.includes(' (Premium)')) {
                            option.textContent += ' (Premium)';
                        }
                    }
                }
            });

            // Atur visibilitas tombol upgrade
            // Tampilkan tombol upgrade hanya jika pengguna login (bukan anonim) dan belum premium
            if (currentUser && currentUser.email && !isUserPremium) {
                upgradePremiumBtn.classList.remove('hidden');
            } else {
                upgradePremiumBtn.classList.add('hidden');
            }

            // Atur visibilitas dan status input kustom
            if (panjangMakalahSelect.value === 'custom_premium' && isUserPremium) {
                customWordCountContainer.style.display = 'block';
                customWordCountInput.disabled = false;
            } else {
                customWordCountContainer.style.display = 'none';
                customWordCountInput.disabled = true;
                customWordCountInput.value = ''; // Bersihkan nilai saat disembunyikan
            }

            // Perbarui teks status autentikasi
            if (currentUser && currentUser.email) { // Jika user login dengan email
                authStatus.textContent = `Masuk sebagai: ${currentUser.email}`;
            } else if (currentUser) { // Jika user login anonim
                authStatus.textContent = `Masuk sebagai: Pengguna Anonim`;
            } else { // Jika belum login
                authStatus.textContent = `Anda belum masuk.`;
            }

            if (isUserPremium) {
                if (currentUser && currentUser.email) {
                    authStatus.textContent += ' (Premium)';
                } else if (currentUser) {
                    authStatus.textContent = `Masuk sebagai: Premium Anonim`;
                }
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            const judulMakalahInput = document.getElementById('judulMakalah');
            const kerangkaMakalahTextarea = document.getElementById('kerangkaMakalah');
            const panjangMakalahSelect = document.getElementById('panjangMakalah');
            const customWordCountContainer = document.getElementById('customWordCountContainer');
            const customWordCountInput = document.getElementById('customWordCountInput');
            const generateBtn = document.getElementById('generateBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultArea = document.getElementById('resultArea');
            const generatedOutlineContainer = document.getElementById('generatedOutlineContainer');
            const outlineContentDiv = document.getElementById('outlineContent');
            const makalahContentDiv = document.getElementById('makalahContent');
            const copyContentBtn = document.getElementById('copyContentBtn');

            // Elemen Autentikasi
            const authSection = document.getElementById('authSection');
            const authTitle = document.getElementById('authTitle');
            const authStatus = document.getElementById('authStatus');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const upgradePremiumBtn = document.getElementById('upgradePremiumBtn'); // Tombol upgrade

            // Inisialisasi Firebase
            try {
                console.log("Firebase: Memulai inisialisasi Firebase dengan config:", firebaseConfig);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                analytics = getAnalytics(app);
                console.log("Firebase: Inisialisasi Firebase berhasil.");

                console.log("Firebase Auth: Memeriksa token autentikasi awal...");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        console.log("Firebase Auth: Mencoba masuk dengan token kustom.");
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Firebase Auth: Berhasil masuk dengan token kustom.");
                    } catch (tokenError) {
                        console.error("Firebase Auth: Gagal masuk dengan token kustom. Mencoba anonim. Error:", tokenError);
                        await signInAnonymously(auth);
                        console.log("Firebase Auth: Berhasil masuk secara anonim setelah token kustom gagal.");
                    }
                } else {
                    console.log("Firebase Auth: Token kustom tidak ditemukan, mencoba masuk secara anonim.");
                    await signInAnonymously(auth);
                    console.log("Firebase Auth: Berhasil masuk secara anonim.");
                }

            } catch (error) {
                console.error("Firebase: Error saat inisialisasi atau masuk:", error);
                showMessage(`Gagal menginisialisasi Firebase: ${error.message}. Fitur akun mungkin tidak berfungsi.`);
            }

            // Listener perubahan status autentikasi
            onAuthStateChanged(auth, async (user) => {
                console.log("Firebase Auth State Changed. User:", user ? user.uid : "null");
                if (user) {
                    userId = user.uid;
                    authStatus.classList.remove('logged-out');
                    authStatus.classList.add('logged-in');
                    loginBtn.classList.add('hidden');
                    registerBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    emailInput.value = user.email || '';
                    emailInput.disabled = true;
                    passwordInput.value = '';
                    passwordInput.disabled = true;
                    authTitle.textContent = "Status Akun";

                    // Simpan data pengguna dasar di Firestore jika belum ada
                    // Pastikan `db` dan `appId` sudah terinisialisasi sebelum memanggil Firestore
                    if (db && appId) {
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                        console.log("Firestore: Mencoba mendapatkan dokumen profil pengguna untuk UID:", userId);
                        try {
                            const userDocSnap = await getDoc(userDocRef);
                            if (!userDocSnap.exists()) {
                                console.log("Firestore: Profil pengguna tidak ditemukan, membuat yang baru.");
                                await setDoc(userDocRef, {
                                    email: user.email || null,
                                    createdAt: new Date(),
                                    isPremium: false // Default non-premium
                                });
                                console.log("Firestore: Profil pengguna berhasil dibuat.");
                                isUserPremium = false; // Set status premium
                            } else {
                                console.log("Firestore: Profil pengguna sudah ada.");
                                isUserPremium = userDocSnap.data().isPremium || false; // Ambil status premium dari Firestore
                            }
                        } catch (firestoreError) {
                            console.error("Firestore: Error saat mengakses atau membuat profil pengguna:", firestoreError);
                            showMessage(`Error Firestore: ${firestoreError.message}.`);
                            isUserPremium = false; // Default ke non-premium jika ada error
                        }
                    } else {
                        console.warn("Firestore: Database atau App ID belum terinisialisasi. Tidak dapat menyimpan profil pengguna.");
                        isUserPremium = false; // Default ke non-premium
                    }
                    updatePremiumUI(user); // Perbarui UI setelah mendapatkan status premium, passing user object
                } else {
                    userId = null;
                    isUserPremium = false; // Reset status premium saat logout
                    authStatus.classList.remove('logged-in');
                    authStatus.classList.add('logged-out');
                    loginBtn.classList.remove('hidden');
                    registerBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    emailInput.value = '';
                    emailInput.disabled = false;
                    passwordInput.value = '';
                    passwordInput.disabled = false;
                    authTitle.textContent = "Masuk / Daftar";
                    updatePremiumUI(null); // Perbarui UI saat logout, passing null for user
                }
            });

            // Event Listener untuk Register
            registerBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;

                console.log("Auth: Mencoba mendaftar dengan email:", email);
                if (!email || !password) {
                    showMessage('Email dan password harus diisi.');
                    console.warn("Auth: Email atau password kosong saat pendaftaran.");
                    return;
                }
                if (password.length < 6) {
                    showMessage('Password minimal 6 karakter.');
                    console.warn("Auth: Password terlalu pendek saat pendaftaran.");
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    console.log("Auth: Pendaftaran berhasil untuk user:", user.uid);
                    // Simpan data pengguna dasar di Firestore saat registrasi berhasil
                    const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                    await setDoc(userDocRef, {
                        email: user.email,
                        createdAt: new Date(),
                        isPremium: false
                    });
                    console.log("Firestore: Profil pengguna dibuat setelah pendaftaran.");
                    showMessage('Registrasi berhasil! Anda sekarang masuk.');
                } catch (error) {
                    console.error("Auth: Error saat pendaftaran:", error);
                    let errorMessage = "Gagal mendaftar. ";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage += "Email sudah terdaftar.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage += "Format email tidak valid.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage += "Password terlalu lemah.";
                    } else {
                        errorMessage += error.message;
                    }
                    showMessage(errorMessage);
                }
            });

            // Event Listener untuk Login
            loginBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;

                console.log("Auth: Mencoba masuk dengan email:", email);
                if (!email || !password) {
                    showMessage('Email dan password harus diisi.');
                    console.warn("Auth: Email atau password kosong saat login.");
                    return;
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log("Auth: Login berhasil.");
                    showMessage('Login berhasil! Selamat datang kembali.');
                } catch (error) {
                    console.error("Auth: Error saat login:", error);
                    let errorMessage = "Gagal masuk. ";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage += "Email atau password salah.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage += "Format email tidak valid.";
                    } else {
                        errorMessage += error.message;
                    }
                    showMessage(errorMessage);
                }
            });

            // Event Listener untuk Logout
            logoutBtn.addEventListener('click', async () => {
                console.log("Auth: Mencoba keluar.");
                try {
                    await signOut(auth);
                    console.log("Auth: Berhasil keluar.");
                    showMessage('Anda telah keluar.');
                } catch (error) {
                    console.error("Auth: Error saat keluar:", error);
                    showMessage(`Gagal keluar: ${error.message}`);
                }
            });

            // Event Listener untuk Upgrade ke Premium
            upgradePremiumBtn.addEventListener('click', async () => {
                if (!userId) {
                    showMessage('Anda harus masuk untuk meng-upgrade ke Premium.');
                    return;
                }
                if (isUserPremium) {
                    showMessage('Anda sudah menjadi anggota Premium!');
                    return;
                }

                console.log("Premium: Mencoba meng-upgrade pengguna ke Premium untuk UID:", userId);
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    await updateDoc(userDocRef, {
                        isPremium: true,
                        premiumActivatedAt: new Date()
                    });
                    isUserPremium = true; // Perbarui status premium lokal
                    updatePremiumUI(auth.currentUser); // Perbarui UI, passing auth.currentUser
                    showMessage('Selamat! Akun Anda sekarang Premium!');
                    console.log("Premium: Pengguna berhasil di-upgrade ke Premium.");
                } catch (error) {
                    console.error("Premium: Error saat meng-upgrade ke Premium:", error);
                    showMessage(`Gagal meng-upgrade ke Premium: ${error.message}`);
                }
            });

            // Event Listener untuk perubahan pada dropdown panjang makalah
            panjangMakalahSelect.addEventListener('change', () => {
                updatePremiumUI(auth.currentUser); // Perbarui UI saat pilihan berubah, passing auth.currentUser
            });


            // Logika pembuatan makalah (sama seperti sebelumnya, namun kini membutuhkan userId)
            generateBtn.addEventListener('click', async () => {
                const judul = judulMakalahInput.value.trim();
                const kerangka = kerangkaMakalahTextarea.value.trim();
                const panjang = panjangMakalahSelect.value;
                let finalWordCount = 0; // Untuk menyimpan jumlah kata akhir yang diminta

                console.log("Generator: Tombol Buat Makalah diklik.");
                if (!judul) {
                    showMessage('Harap masukkan judul makalah.');
                    console.warn("Generator: Judul makalah kosong.");
                    return;
                }

                // Cek apakah pengguna sudah login sebelum membuat makalah
                if (!userId) {
                    showMessage('Anda harus masuk untuk membuat makalah.');
                    console.warn("Generator: Pengguna belum masuk, tidak bisa membuat makalah.");
                    return;
                }
                console.log("Generator: Pengguna terautentikasi (UID:", userId, "). Melanjutkan pembuatan makalah.");

                // Cek fitur premium berdasarkan pilihan panjang
                const premiumLengths = ['5000_kata', 'custom_premium'];
                if (premiumLengths.includes(panjang) && !isUserPremium) {
                    showMessage('Fitur ini hanya tersedia untuk anggota Premium. Silakan upgrade akun Anda.');
                    console.warn("Generator: Pengguna non-premium mencoba mengakses fitur premium.");
                    return;
                }

                // Tentukan jumlah kata akhir yang diminta
                if (panjang === 'custom_premium') {
                    const customValue = parseInt(customWordCountInput.value, 10);
                    if (isNaN(customValue) || customValue < 5000 || customValue > 12000) {
                        showMessage('Untuk panjang kustom, masukkan angka antara 5000 hingga 12000.');
                        console.warn("Generator: Input jumlah kata kustom tidak valid.");
                        return;
                    }
                    finalWordCount = customValue;
                } else if (panjang === 'pendek') {
                    finalWordCount = 500;
                } else if (panjang === 'sedang') {
                    finalWordCount = 1000;
                } else if (panjang === 'panjang') {
                    finalWordCount = 1500;
                } else if (panjang === '4000_kata') {
                    finalWordCount = 4000;
                } else if (panjang === '4250_kata') {
                    finalWordCount = 4250;
                } else if (panjang === '5000_kata') {
                    finalWordCount = 5000;
                }
                console.log("Generator: Jumlah kata yang diminta:", finalWordCount);


                loadingIndicator.classList.add('active');
                generateBtn.disabled = true;
                resultArea.classList.add('hidden'); // Sembunyikan area hasil sebelumnya
                generatedOutlineContainer.classList.add('hidden'); // Sembunyikan kerangka sebelumnya

                try {
                    let prompt = `Buatkan draf makalah akademik berdasarkan informasi berikut:\n\n`;
                    prompt += `Judul: ${judul}\n\n`;
                    
                    if (kerangka) { // Hanya tambahkan kerangka jika tidak kosong
                        prompt += `Kerangka yang diberikan: ${kerangka}\n\n`;
                        prompt += `Ulangi kerangka yang diberikan dalam format daftar bernomor atau berpoin sederhana di bagian "**KERANGKA MAKALAH:**", dan kemudian kembangkan isinya di bagian "**ISI MAKALAH:**".\n\n`;
                    } else {
                        prompt += `Buat kerangka makalah yang relevan secara otomatis berdasarkan judul dalam format daftar bernomor atau berpoin sederhana di bagian "**KERANGKA MAKALAH:**", dan kemudian kembangkan isinya di bagian "**ISI MAKALAH:**".\n\n`;
                    }

                    prompt += `Isi makalah harus sekitar ${finalWordCount} kata.\n\n`;
                    prompt += `Gunakan format penulisan akademik yang standar dengan "Daftar Isi" di awal, diikuti oleh Bab (BAB I, BAB II, dst.) dan sub-judul.`;
                    prompt += ` Untuk setiap beberapa paragraf, sisipkan catatan kaki placeholder seperti '[1]', '[2]', dst. di akhir kalimat yang relevan.`;
                    prompt += ` Di bagian akhir makalah, setelah semua bab, sertakan bagian '**CATATAN KAKI:**' yang berisi daftar catatan kaki placeholder dan deskripsi singkatnya (misalnya, '1. Catatan kaki tentang definisi X.').`;
                    prompt += ` Setelah itu, sertakan bagian '**DAFTAR PUSTAKA:**' dengan setidaknya 3-5 entri placeholder yang relevan (misalnya, 'Nama Penulis. (Tahun). Judul Buku/Artikel. Penerbit/Jurnal.').`;
                    prompt += ` **Penting: Jangan sertakan sitasi atau referensi palsu. Jika Anda perlu menyebutkan sumber, gunakan placeholder seperti "[Sumber: Nama Penulis, Tahun]" atau "[Referensi diperlukan]".**`;
                    prompt += `\n\n**KERANGKA MAKALAH:**\n`; // Marker untuk kerangka
                    prompt += `\n**ISI MAKALAH:**\n`; // Marker untuk isi

                    console.log("Generator: Prompt yang dikirim ke Gemini:", prompt);

                    // Panggil Gemini API
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    // PENTING: GANTI INI DENGAN KUNCI API GOOGLE CLOUD ANDA SENDIRI!
                    // Kunci API ini harus memiliki akses ke Generative Language API.
                    // Contoh: const apiKey = "AIzaSyB-IniAdalahKunciAPIAndaYangValid";
                    const apiKey = "AIzaSyAGPK4bhFmvUNs7ZauZOtJtESevSzhbUhw"; // <<< PASTIKAN INI DIISI DENGAN KUNCI API GEMINI ANDA JIKA DI GITHUB PAGES

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    console.log("Generator: Memanggil Gemini API di URL:", apiUrl);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Tambahkan penanganan kesalahan untuk respons HTTP
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("Generator: Kesalahan respons HTTP dari Gemini API. Status:", response.status, "Body:", errorBody);
                        if (response.status === 401 || response.status === 403) {
                            throw new Error(`Kesalahan Otorisasi API Gemini (Status: ${response.status}). Pastikan Kunci API Gemini Anda valid dan memiliki izin yang benar. Respons: ${errorBody}`);
                        } else {
                            throw new Error(`Kesalahan HTTP dari Gemini API! Status: ${response.status}, Respons: ${errorBody}`);
                        }
                    }

                    const result = await response.json();
                    console.log("Generator: Respons Gemini API:", result);

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        console.log("Generator: Teks mentah dari Gemini:", rawText);
                        
                        // Pisahkan kerangka, isi makalah, catatan kaki, dan daftar pustaka
                        const outlineMarker = "**KERANGKA MAKALAH:**";
                        const contentMarker = "**ISI MAKALAH:**";
                        const footnotesMarker = "**CATATAN KAKI:**";
                        const bibliographyMarker = "**DAFTAR PUSTAKA:**";

                        let outlineText = '';
                        let makalahText = '';
                        let footnotesText = '';
                        let bibliographyText = '';

                        // Split by markers
                        const parts = rawText.split(outlineMarker);
                        if (parts.length > 1) {
                            const contentAndBeyond = parts[1].split(contentMarker);
                            outlineText = contentAndBeyond[0].trim();
                            if (contentAndBeyond.length > 1) {
                                const footnotesAndBeyond = contentAndBeyond[1].split(footnotesMarker);
                                makalahText = footnotesAndBeyond[0].trim();
                                if (footnotesAndBeyond.length > 1) {
                                    const bibliographyAndBeyond = footnotesAndBeyond[1].split(bibliographyMarker);
                                    footnotesText = bibliographyAndBeyond[0].trim();
                                    if (bibliographyAndBeyond.length > 1) {
                                        bibliographyText = bibliographyAndBeyond[1].trim();
                                    }
                                }
                            }
                        } else {
                            // Fallback if markers are not found, assume entire text is content
                            makalahText = rawText;
                            outlineText = "Kerangka tidak dapat diekstrak secara otomatis. Silakan lihat isi makalah.";
                            footnotesText = "Catatan kaki tidak dapat diekstrak secara otomatis.";
                            bibliographyText = "Daftar pustaka tidak dapat diekstrak secara otomatis.";
                        }

                        // Format kerangka makalah
                        let formattedOutline = outlineText
                            .replace(/^\d+\.\s*(.*)$/gm, '<li>$1</li>') // Nomor
                            .replace(/^[a-z]\.\s*(.*)$/gm, '<li>$1</li>') // Huruf
                            .replace(/^\-\s*(.*)$/gm, '<li>$1</li>'); // Bullet
                        
                        if (formattedOutline.includes('<li>')) {
                            // Crude way to handle nested lists, might need more robust parsing for complex outlines
                            formattedOutline = `<ul>${formattedOutline}</ul>`;
                            formattedOutline = formattedOutline.replace(/<\/li>\s*<li>/g, '</li><li>'); // Clean up extra spaces
                            formattedOutline = formattedOutline.replace(/<li>\s*([a-z]\.)/g, '<ul><li>$1'); // Basic nested list for a. b.
                            formattedOutline = formattedOutline.replace(/(<\/li>)(?!.*<li>)/g, '</li></ul>'); // Close nested lists
                        } else {
                            formattedOutline = `<p>${outlineText}</p>`; // Jika tidak ada list, tampilkan sebagai paragraf
                        }

                        outlineContentDiv.innerHTML = formattedOutline;
                        generatedOutlineContainer.classList.remove('hidden');

                        // Format isi makalah
                        let formattedMakalah = makalahText
                            .replace(/^(Daftar Isi)$/gmi, '<h2 class="section-heading">$1</h2>') // Daftar Isi
                            .replace(/^(BAB\s[IVXLCDM]+\s*:\s*.*)$/gm, '<h2 class="bab-heading">$1</h2>') // Menangkap BAB I, BAB II, dst.
                            .replace(/^### (.*)$/gm, '<h3 class="text-2xl font-semibold mt-6 mb-3">$1</h3>') // Sub-judul H3
                            .replace(/^## (.*)$/gm, '<h2 class="text-xl font-semibold mt-5 mb-2">$1</h2>') // Sub-judul H2 (jika ada)
                            .replace(/^# (.*)$/gm, '<h1 class="text-3xl font-bold mt-8 mb-4">$1</h1>'); // Judul H1 (jika ada)
                        
                        // Format catatan kaki placeholder [1], [2]
                        formattedMakalah = formattedMakalah.replace(/\[(\d+)\]/g, '<sup class="footnote-ref">[$1]</sup>');

                        formattedMakalah = formattedMakalah.replace(/^\* (.*)$/gm, '<li>$1</li>');
                        formattedMakalah = formattedMakalah.replace(/(\n<li>.*<\/li>)+/gs, '<ul class="list-disc ml-6 mb-4">$1</ul>');

                        formattedMakalah = formattedMakalah.split('\n\n').map(p => {
                            if (p.startsWith('<h') || p.startsWith('<ul') || p.startsWith('<div')) {
                                return p;
                            }
                            return `<p class="mb-4">${p.trim()}</p>`;
                        }).join('');

                        // Tambahkan Catatan Kaki
                        if (footnotesText) {
                            formattedMakalah += `<h2 class="section-heading">Catatan Kaki</h2>`;
                            formattedMakalah += `<ul class="list-unstyled text-gray-700">`;
                            footnotesText.split('\n').forEach(line => {
                                if (line.trim()) {
                                    formattedMakalah += `<li>${line.trim()}</li>`;
                                }
                            });
                            formattedMakalah += `</ul>`;
                        }

                        // Tambahkan Daftar Pustaka
                        if (bibliographyText) {
                            formattedMakalah += `<h2 class="section-heading">Daftar Pustaka</h2>`;
                            formattedMakalah += `<ul class="list-unstyled text-gray-700">`;
                            bibliographyText.split('\n').forEach(line => {
                                if (line.trim()) {
                                    formattedMakalah += `<li>${line.trim()}</li>`;
                                }
                            });
                            bibliographyText += `</ul>`;
                        }


                        makalahContentDiv.innerHTML = formattedMakalah;
                        resultArea.classList.remove('hidden'); // Tampilkan area hasil
                        console.log("Generator: Makalah berhasil ditampilkan.");
                    } else {
                        showMessage('Gagal menghasilkan makalah. Coba lagi. Respons API tidak terduga.');
                        console.error('Generator: Struktur respons API tidak terduga:', result);
                    }
                } catch (error) {
                    showMessage(`Terjadi kesalahan: ${error.message}. Silakan periksa konsol untuk detail.`);
                    console.error('Generator: Error saat membuat makalah:', error);
                } finally {
                    loadingIndicator.classList.remove('active');
                    generateBtn.disabled = false;
                    console.log("Generator: Proses pembuatan makalah selesai.");
                }
            });

            copyContentBtn.addEventListener('click', () => {
                console.log("Copy: Tombol Salin Konten diklik.");
                let fullTextToCopy = '';

                // 1. Salin Kerangka Makalah yang Dihasilkan (jika terlihat)
                if (!generatedOutlineContainer.classList.contains('hidden')) {
                    fullTextToCopy += 'KERANGKA MAKALAH YANG DIHASILKAN:\n\n';
                    const outlineElements = outlineContentDiv.querySelectorAll('ul, li, p');
                    outlineElements.forEach(el => {
                        if (el.tagName === 'LI') {
                            let prefix = '';
                            let parentUl = el.closest('ul');
                            if (parentUl) {
                                let listStyle = window.getComputedStyle(parentUl).listStyleType;
                                if (listStyle === 'decimal') {
                                    prefix = `${Array.from(parentUl.children).indexOf(el) + 1}. `;
                                } else if (listStyle === 'lower-alpha') {
                                    prefix = `${String.fromCharCode(97 + Array.from(parentUl.children).indexOf(el))}. `;
                                } else {
                                    prefix = '- '; // Default untuk disc, square, dll.
                                }
                            } else {
                                prefix = '- '; // Fallback jika tidak dalam daftar
                            }
                            fullTextToCopy += `${prefix}${el.textContent.trim()}\n`;
                        } else if (el.tagName === 'P') {
                            fullTextToCopy += `${el.textContent.trim()}\n`;
                        }
                    });
                    fullTextToCopy += '\n';
                }

                // 2. Salin Konten Makalah Utama (termasuk Bab, sub-judul, paragraf, daftar, catatan kaki, daftar pustaka)
                fullTextToCopy += 'ISI MAKALAH:\n\n';
                const mainContentElements = makalahContentDiv.children; // Dapatkan semua anak langsung (h2, h3, p, ul)

                Array.from(mainContentElements).forEach(element => {
                    if (element.classList.contains('section-heading') || element.classList.contains('bab-heading')) {
                        fullTextToCopy += `\n${element.textContent.trim().toUpperCase()}\n\n`;
                    } else if (element.tagName === 'P') {
                        fullTextToCopy += `${element.textContent.trim()}\n\n`;
                    } else if (element.tagName === 'UL') {
                        Array.from(element.querySelectorAll('li')).forEach(li => {
                            fullTextToCopy += `- ${li.textContent.trim()}\n`;
                        });
                        fullTextToCopy += '\n';
                    }
                });
                console.log("Copy: Teks yang akan disalin:", fullTextToCopy);

                // Gunakan textarea sementara untuk menyalin teks yang sudah diformat
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = fullTextToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                tempTextArea.setSelectionRange(0, 99999); // Untuk perangkat seluler

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showMessage('Konten makalah (kerangka & isi) berhasil disalin!');
                        console.log("Copy: Konten berhasil disalin.");
                    } else {
                        showMessage('Gagal menyalin konten. Silakan salin secara manual.');
                        console.warn("Copy: Gagal menyalin konten menggunakan execCommand.");
                    }
                } catch (err) {
                    showMessage('Gagal menyalin konten. Silakan salin secara manual.');
                    console.error('Copy: Error saat menyalin teks:', err);
                } finally {
                    document.body.removeChild(tempTextArea);
                    console.log("Copy: Textarea sementara dihapus.");
                }
            });
        });
    </script>
</body>
</html>
