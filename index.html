<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rell Makalah AI - Generator Makalah Otomatis Online Gratis</title>
    <meta name="google-site-verification" content="hc7xIt5KLo-DjPjK1E7aFJjOxEsPrnBbSU9hIByzmZc" />
<!-- Deskripsi meta untuk SEO -->
    <meta name="description" content="Rell Makalah AI adalah generator makalah otomatis yang membantu Anda menyusun draf makalah dengan cepat berdasarkan judul dan kerangka.">
    
    <!-- Ikon Website (Favicon) -->
    <!-- Ikon ini menggabungkan elemen AI (sirkuit/glowing) yang terintegrasi langsung dengan simbol dokumen. -->
    <!-- Kata 'Rell' juga terintegrasi secara halus dan sedikit lebih kecil di dalam desain ikon. -->
    <!-- Palet warna deep blues, purples, dan cyan/green accents cocok untuk latar belakang gelap. -->
    <!-- Desainnya minimalis, futuristik, bersih, modern, dan mudah dikenali pada ukuran kecil. -->
    <!-- Diperbarui untuk menggunakan file dari paket generator favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="shortcut icon" href="/favicon.ico"> <!-- Penting untuk kompatibilitas lama -->
    
    <!-- Google Fonts untuk tampilan futuristik -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Space+Mono&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur variabel CSS untuk warna dan font */
        :root {
            --primary-blue: #00bcd4; /* Cyan terang */
            --secondary-purple: #8e24aa; /* Ungu */
            --dark-bg: #1a1a2e; /* Latar belakang gelap */
            --light-text: #e0e0e0; /* Teks terang */
            --accent-green: #00e676; /* Hijau aksen */
            --accent-red: #ff1744; /* Merah aksen */
            --gradient-1: linear-gradient(90deg, #00bcd4, #8e24aa);
            --gradient-2: linear-gradient(90deg, #00e676, #00bcd4);
            --font-orbitron: 'Orbitron', sans-serif;
            --font-space-mono: 'Space Mono', monospace;
            --font-inter: 'Inter', sans-serif;
        }

        /* Styling dasar body untuk tampilan full-size dan futuristik */
        body {
            font-family: var(--font-inter);
            background: var(--dark-bg); /* Latar belakang gelap */
            background-image: radial-gradient(circle at top left, rgba(0, 188, 212, 0.15) 0%, transparent 50%),
                              radial-gradient(circle at bottom right, rgba(142, 36, 170, 0.15) 0%, transparent 50%);
            color: var(--light-text); /* Warna teks terang */
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 0; /* Hapus padding dari body untuk mobile */
            margin: 0; /* Pastikan tidak ada margin default */
            box-sizing: border-box;
            overflow-x: hidden; /* Mencegah scroll horizontal */
        }

        /* Container utama yang responsif penuh */
        .container {
            background-color: rgba(26, 26, 46, 0.8); /* Latar belakang semi-transparan */
            backdrop-filter: blur(8px); /* Efek blur pada latar belakang */
            padding: 2rem 1rem; /* Padding vertikal 2rem, horizontal 1rem untuk mobile */
            border-radius: 0; /* Hapus border-radius di mobile agar full-width */
            box-shadow: none; /* Hapus shadow di mobile */
            width: 100%; /* Selalu 100% lebar */
            max-width: 900px; /* Batasi lebar maksimum untuk desktop */
            display: flex;
            flex-direction: column;
            gap: 1.8rem; /* Jarak antar elemen lebih besar */
            border: none; /* Hapus border di mobile */
        }

        /* Media query untuk desktop (layar > 768px) */
        @media (min-width: 768px) {
            body {
                padding: 2rem; /* Tambahkan padding kembali untuk desktop */
            }
            .container {
                padding: 3rem; /* Padding standar untuk desktop */
                border-radius: 1.5rem; /* Terapkan border-radius untuk desktop */
                box-shadow: 0 0 30px rgba(0, 188, 212, 0.3), 0 0 60px rgba(142, 36, 170, 0.2); /* Terapkan shadow untuk desktop */
                border: 1px solid rgba(0, 188, 212, 0.3); /* Terapkan border untuk desktop */
            }
        }

        h1 {
            font-family: var(--font-orbitron); /* Font futuristik untuk judul utama */
            font-size: 3.5rem; /* Ukuran lebih besar */
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            /* Efek gradien teks */
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; /* Fallback */
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.5), 0 0 20px rgba(142, 36, 170, 0.3);
        }

        .owner-text {
            font-family: var(--font-space-mono); /* Font keren untuk teks owner */
            font-size: 0.9rem; /* Ukuran sedikit lebih besar */
            color: var(--light-text);
            text-align: center;
            opacity: 0.6; /* Opacity lebih tinggi agar lebih terlihat */
            margin-top: -0.5rem; /* Naikkan sedikit agar dekat dengan judul */
            margin-bottom: 1.5rem;
            text-shadow: 0 0 5px rgba(0, 188, 212, 0.2);
        }

        p {
            font-size: 1.1rem; /* Ukuran paragraf lebih besar */
            color: var(--light-text); /* Pastikan paragraf menggunakan warna terang */
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem; /* Jarak label lebih besar */
            font-weight: 600;
            color: var(--light-text);
            font-size: 1.1rem; /* Ukuran label lebih besar */
        }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="email"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 1rem; /* Padding input lebih besar */
            border: 1px solid rgba(0, 188, 212, 0.4); /* Border dengan warna aksen */
            border-radius: 0.75rem; /* Sudut lebih membulat */
            font-size: 1.1rem; /* Ukuran font input lebih besar */
            background-color: rgba(0, 0, 0, 0.3); /* Latar belakang input gelap transparan */
            color: var(--light-text);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input[type="text"]:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(0, 188, 212, 0.4); /* Efek glow saat fokus */
        }
        .form-group textarea {
            min-height: 150px; /* Tinggi minimum textarea */
        }

        .btn-primary, .btn-secondary {
            background: var(--gradient-1); /* Gradien untuk tombol utama */
            color: #ffffff;
            font-weight: 700;
            padding: 1rem 2.5rem; /* Padding tombol lebih besar */
            border: none;
            border-radius: 0.75rem;
            font-size: 1.2rem; /* Ukuran font tombol lebih besar */
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 188, 212, 0.4); /* Efek shadow/glow */
            width: fit-content;
            align-self: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1rem; /* Jarak antar tombol */
        }
        .btn-primary:hover {
            background: var(--gradient-2); /* Gradien berbeda saat hover */
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 230, 118, 0.5); /* Efek glow lebih kuat */
        }
        .btn-primary:disabled, .btn-secondary:disabled {
            background: #4a4a68; /* Warna abu-abu saat dinonaktifkan */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        .btn-secondary {
            background: #4a4a68; /* Warna abu-abu untuk tombol sekunder */
            box-shadow: 0 5px 15px rgba(74, 74, 104, 0.4);
        }
        .btn-secondary:hover {
            background: #6a6a8a;
            box-shadow: 0 8px 20px rgba(106, 106, 138, 0.5);
        }

        .loading-indicator {
            display: none;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--primary-blue);
            font-size: 1.1rem;
            font-weight: 600;
        }
        .loading-indicator.active {
            display: block;
        }
        .result-area {
            background-color: rgba(0, 0, 0, 0.3); /* Latar belakang hasil gelap transparan */
            border: 1px solid rgba(0, 188, 212, 0.3);
            border-radius: 0.75rem;
            padding: 2rem; /* Padding lebih besar */
            min-height: 250px; /* Tinggi minimum lebih besar */
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--light-text); /* Pastikan area hasil menggunakan warna terang */
            font-size: 1.1rem; /* Ukuran font hasil lebih besar */
            line-height: 1.8; /* Line height lebih lega */
            margin-top: 1.8rem;
            box-shadow: inset 0 0 10px rgba(0, 188, 212, 0.1);
        }
        .result-area h2 {
            font-size: 2rem; /* Ukuran judul hasil lebih besar */
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--primary-blue);
            text-shadow: 0 0 8px rgba(0, 188, 212, 0.4);
        }
        .warning-message {
            background-color: rgba(255, 235, 179, 0.2); /* Kuning sangat terang transparan */
            border-left: 4px solid #ffc107; /* Kuning oranye */
            color: #ffeb3b; /* Teks kuning terang */
            padding: 1.2rem; /* Padding lebih besar */
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.2);
        }
        .copy-button {
            background: var(--gradient-2); /* Gradien untuk tombol salin */
            color: #ffffff;
            font-weight: 700;
            padding: 0.9rem 2rem; /* Padding tombol lebih besar */
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
            width: fit-content;
            align-self: flex-end;
            margin-top: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 230, 118, 0.4);
        }
        .copy-button:hover {
            background: var(--gradient-1);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 188, 212, 0.5);
        }
        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--accent-green);
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 1000;
            font-size: 1.2rem;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.5);
            border: 1px solid var(--accent-green);
        }

        /* Styling untuk kerangka yang dihasilkan */
        #generatedOutlineContainer {
            background-color: rgba(0, 188, 212, 0.1); /* Latar belakang biru muda transparan */
            border: 1px solid rgba(0, 188, 212, 0.5); /* Border biru */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--light-text); /* Warna teks terang */
            box-shadow: inset 0 0 10px rgba(0, 188, 212, 0.1);
        }
        #generatedOutlineContainer h3 {
            font-size: 1.6rem; /* Ukuran lebih besar */
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-blue);
            text-shadow: 0 0 5px rgba(0, 188, 212, 0.3);
        }
        #outlineContent ul {
            list-style-type: decimal;
            margin-left: 1.8rem; /* Margin lebih besar */
            font-size: 1rem;
            color: var(--light-text); /* Pastikan list di outline menggunakan warna terang */
        }
        #outlineContent ul ul {
            list-style-type: lower-alpha;
            margin-left: 1.8rem;
        }
        #outlineContent ul ul ul {
            list-style-type: lower-roman;
            margin-left: 1.8rem;
        }
        #outlineContent li {
            margin-bottom: 0.5rem; /* Jarak antar list item lebih besar */
        }

        /* Styling untuk Bab */
        .bab-heading {
            font-size: 2.8rem; /* Ukuran sangat besar untuk BAB */
            font-weight: 800;
            color: var(--accent-green); /* Warna aksen hijau */
            margin-top: 3.5rem; /* Margin lebih besar */
            margin-bottom: 2rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(0, 230, 118, 0.6);
        }

        /* Styling untuk Daftar Isi, Catatan Kaki, Daftar Pustaka */
        .section-heading {
            font-size: 2.2rem; /* Ukuran lebih besar */
            font-weight: 700;
            color: var(--primary-blue);
            margin-top: 2.5rem;
            margin-bottom: 1.2rem;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.4);
        }
        .list-unstyled {
            list-style: none;
            padding-left: 0;
            color: var(--light-text); /* Pastikan list unstyled menggunakan warna terang */
        }
        .footnote-ref {
            vertical-align: super;
            font-size: 0.8em; /* Ukuran sedikit lebih besar */
            color: var(--accent-green); /* Warna aksen hijau */
            text-decoration: none;
            margin-left: 3px;
            font-weight: 700;
        }
        .footnote-ref:hover {
            text-decoration: underline;
        }

        /* Styling untuk Auth Section */
        #authSection {
            background-color: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(0, 188, 212, 0.2);
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #authSection h3 {
            font-size: 1.8rem;
            font-family: var(--font-orbitron);
            color: var(--primary-blue);
            text-align: center;
            margin-bottom: 1rem;
        }
        #authStatus {
            text-align: center;
            font-size: 1.1rem;
            color: var(--accent-green);
        }
        #authStatus.logged-out {
            color: var(--accent-red);
        }
        .auth-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap; /* Wrap buttons on small screens */
        }
        .auth-buttons .btn-primary, .auth-buttons .btn-secondary {
            margin-top: 0.5rem; /* Reduce margin top for auth buttons */
        }
        /* Styling untuk tombol premium */
        .btn-premium {
            background: linear-gradient(90deg, #ffc107, #ff8f00); /* Gradien emas/oranye */
            color: #1a1a2e; /* Teks gelap */
            font-weight: 700;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.5);
            width: fit-content;
            align-self: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1rem;
        }
        .btn-premium:hover {
            background: linear-gradient(90deg, #ffeb3b, #ffc107);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(255, 235, 59, 0.6);
        }
        .btn-premium:disabled {
            background: #6a6a68;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        /* Styling untuk opsi select yang dinonaktifkan */
        option[disabled] {
            color: #888;
            font-style: italic;
        }
        /* Styling untuk custom word count input */
        #customWordCountContainer {
            display: none; /* Sembunyikan secara default */
            margin-top: 1rem;
            text-align: center;
        }
        #customWordCountContainer label {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: var(--light-text);
        }
        #customWordCountInput {
            max-width: 200px;
            margin: 0 auto;
        }
        /* Menambahkan styling untuk paragraf di makalah agar rata kiri */
        #makalahContent p {
            text-align: left; /* Paragraf rata kiri */
            color: var(--light-text); /* Pastikan warna teks terang */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center mb-0">
            Rell Makalah AI
        </h1>
        <p class="owner-text">
            own by Ver3l4U
        </p>

        <!-- Bagian Autentikasi -->
        <div id="authSection">
            <h3 id="authTitle">Masuk / Daftar</h3>
            <div id="authStatus" class="logged-out">Anda belum masuk.</div>
            <div id="authForm" class="flex flex-col gap-4">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="Minimal 6 karakter">
                </div>
                <div class="auth-buttons">
                    <button id="loginBtn" class="btn-primary">Masuk</button>
                    <button id="registerBtn" class="btn-secondary">Daftar</button>
                    <button id="logoutBtn" class="btn-secondary hidden">Keluar</button>
                </div>
                <button id="upgradePremiumBtn" class="btn-premium hidden">Upgrade ke Premium!</button>
            </div>
        </div>

        <p class="text-md text-gray-600 text-center mb-6">
            Masukkan judul dan kerangka makalah Anda (opsional), lalu biarkan AI membantu menyusun draf awal.
        </p>

        <div class="warning-message">
            **Penting:** Makalah yang dihasilkan adalah draf awal. Anda **wajib** melakukan riset mendalam,
            memeriksa fakta, menambahkan sitasi yang akurat, dan melakukan revisi menyeluruh
            sebelum menggunakan atau menyerahkan makalah ini.
        </div>

        <div class="form-group mt-6">
            <label for="judulMakalah">Judul Makalah:</label>
            <input type="text" id="judulMakalah" placeholder="Contoh: Dampak Teknologi AI terhadap Masa Depan Pendidikan">
        </div>

        <div class="form-group">
            <label for="kerangkaMakalah">Kerangka Makalah / Poin Utama (opsional, pisahkan dengan baris baru):</label>
            <textarea id="kerangkaMakalah" rows="8" placeholder="Contoh:
1. Pendahuluan
   a. Latar Belakang
   b. Rumusan Masalah
   c. Tujuan Penulisan
2. Tinjauan Pustaka
   a. Definisi AI dalam Pendidikan
   b. Teori Pembelajaran Digital
3. Pembahasan
   a. Integrasi AI dalam Kurikulum
   b. Tantangan Implementasi AI
   c. Peluang AI untuk Personalisasi Pembelajaran
4. Kesimpulan
   a. Ringkasan Temuan
   b. Saran dan Implikasi"></textarea>
        </div>

        <div class="form-group">
            <label for="panjangMakalah">Panjang Makalah (opsional):</label>
            <select id="panjangMakalah">
                <option value="pendek">Pendek (sekitar 500 kata)</option>
                <option value="sedang" selected>Sedang (sekitar 1000 kata)</option>
                <option value="panjang">Panjang (sekitar 1500 kata)</option>
                <option value="4000_kata">4000 kata</option>
                <option value="4250_kata">4250 kata</option>
                <option value="5000_kata" disabled>5000 kata (Premium)</option>
                <option value="custom_premium" disabled>Kustom (5000-12000 kata, Premium)</option>
            </select>
        </div>

        <div id="customWordCountContainer" class="form-group">
            <label for="customWordCountInput">Jumlah Kata Kustom (5000 - 12000):</label>
            <input type="number" id="customWordCountInput" min="5000" max="12000" placeholder="Masukkan jumlah kata">
        </div>

        <button id="generateBtn" class="btn-primary">
            Buat Makalah
        </button>

        <div id="loadingIndicator" class="loading-indicator">
            Memuat... Mohon tunggu sebentar.
        </div>

        <div class="result-area hidden" id="resultArea">
            <h2>Draf Makalah Anda:</h2>
            <div id="generatedOutlineContainer" class="hidden">
                <h3>Kerangka Makalah yang Dihasilkan:</h3>
                <div id="outlineContent" class="text-gray-700">
                    <!-- Outline will go here -->
                </div>
            </div>
            <div id="makalahContent" class="text-gray-800">
                <!-- Konten makalah yang dihasilkan AI akan muncul di sini -->
            </div>
            <button id="copyContentBtn" class="copy-button">
                Salin Konten
            </button>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Global Firebase instances
        let app, auth, db, analytics;
        let userId = null; // To store the current user's UID
        let isUserPremium = false; // User's premium status

        // Declare appId globally within the module scope
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Prioritize __firebase_config from the Canvas environment if available.
        // Otherwise, use a hardcoded configuration (for GitHub Pages).
        let firebaseConfig = {};
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Firebase Init: Using Canvas configuration.");
            } catch (e) {
                console.error("Firebase Init: Error parsing __firebase_config:", e);
                console.log("Firebase Init: Failed to parse Canvas configuration, using hardcoded configuration.");
                // PASTIKAN OBJEK firebaseConfig YANG ANDA SALIN DITEMPEL DI SINI
                // For Firebase JS SDK v7.20.0 and later, measurementId is optional
 firebaseConfig = {
  apiKey: "AIzaSyA-LE_wG_0WLmvOQ51rME4t8zw-WWEi914",
  authDomain: "rell-makalah-ai-project-89a29.firebaseapp.com",
  projectId: "rell-makalah-ai-project-89a29",
  storageBucket: "rell-makalah-ai-project-89a29.firebasestorage.app",
  messagingSenderId: "862112040534",
  appId: "1:862112040534:web:6bec7aea2c7ec63f3d5df7",
  measurementId: "G-SJK5Q727K4"
};
            }
        } else {
            // Use hardcoded configuration if __firebase_config is not defined (e.g., on GitHub Pages)
            console.log("Firebase Init: __firebase_config not found, using hardcoded configuration.");
            // PASTIKAN OBJEK firebaseConfig YANG SAMA DITEMPEL DI SINI JUGA
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
 firebaseConfig = {
  apiKey: "AIzaSyA-LE_wG_0WLmvOQ51rME4t8zw-WWEi914",
  authDomain: "rell-makalah-ai-project-89a29.firebaseapp.com",
  projectId: "rell-makalah-ai-project-89a29",
  storageBucket: "rell-makalah-ai-project-89a29.firebasestorage.app",
  messagingSenderId: "862112040534",
  appId: "1:862112040534:web:6bec7aea2c7ec63f3d5df7",
  measurementId: "G-SJK5Q727K4"
};
        }

        // Function to display a temporary message
        function showMessage(message, duration = 2000) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // Function to update the premium UI status
        function updatePremiumUI(currentUser) { // Accepts the user object as a parameter
            const panjangMakalahSelect = document.getElementById('panjangMakalah');
            const customWordCountContainer = document.getElementById('customWordCountContainer');
            const customWordCountInput = document.getElementById('customWordCountInput');
            const upgradePremiumBtn = document.getElementById('upgradePremiumBtn');
            const authStatus = document.getElementById('authStatus');

            // Options that are always free
            const freeOptions = ['pendek', 'sedang', 'panjang', '4000_kata', '4250_kata'];
            // Options that are premium
            const premiumOptionsValues = ['5000_kata', 'custom_premium'];

            panjangMakalahSelect.querySelectorAll('option').forEach(option => {
                if (freeOptions.includes(option.value)) {
                    option.disabled = false;
                    option.textContent = option.textContent.replace(' (Premium)', '');
                } else if (premiumOptionsValues.includes(option.value)) {
                    if (isUserPremium) {
                        option.disabled = false;
                        option.textContent = option.textContent.replace(' (Premium)', '');
                    } else {
                        option.disabled = true;
                        if (!option.textContent.includes(' (Premium)')) {
                            option.textContent += ' (Premium)';
                        }
                    }
                }
            });

            // Set visibility of the upgrade button
            // Show upgrade button only if logged in (not anonymous) and not premium
            if (currentUser && currentUser.email && !isUserPremium) {
                upgradePremiumBtn.classList.remove('hidden');
            } else {
                upgradePremiumBtn.classList.add('hidden');
            }

            // Set visibility and status of the custom input
            if (panjangMakalahSelect.value === 'custom_premium' && isUserPremium) {
                customWordCountContainer.style.display = 'block';
                customWordCountInput.disabled = false;
            } else {
                customWordCountContainer.style.display = 'none';
                customWordCountInput.disabled = true;
                customWordCountInput.value = ''; // Clear value when hidden
            }

            // Update authentication status text
            if (currentUser && currentUser.email) { // If user logs in with email
                authStatus.textContent = `Masuk sebagai: ${currentUser.email}`;
            } else if (currentUser) { // If user logs in anonymously
                authStatus.textContent = `Masuk sebagai: Pengguna Anonim`;
            } else { // If not logged in
                authStatus.textContent = `Anda belum masuk.`;
            }

            if (isUserPremium) {
                if (currentUser && currentUser.email) {
                    authStatus.textContent += ' (Premium)';
                } else if (currentUser) {
                    authStatus.textContent = `Masuk sebagai: Premium Anonim`;
                }
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            const judulMakalahInput = document.getElementById('judulMakalah');
            const kerangkaMakalahTextarea = document.getElementById('kerangkaMakalah');
            const panjangMakalahSelect = document.getElementById('panjangMakalah');
            const customWordCountContainer = document.getElementById('customWordCountContainer');
            const customWordCountInput = document.getElementById('customWordCountInput');
            const generateBtn = document.getElementById('generateBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultArea = document.getElementById('resultArea');
            const generatedOutlineContainer = document.getElementById('generatedOutlineContainer');
            const outlineContentDiv = document.getElementById('outlineContent');
            const makalahContentDiv = document.getElementById('makalahContent');
            const copyContentBtn = document.getElementById('copyContentBtn');

            // Authentication Elements
            const authSection = document.getElementById('authSection');
            const authTitle = document.getElementById('authTitle');
            const authStatus = document.getElementById('authStatus');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const upgradePremiumBtn = document.getElementById('upgradePremiumBtn'); // Upgrade button

            // Firebase Initialization
            try {
                console.log("Firebase: Starting Firebase initialization with config:", firebaseConfig);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                analytics = getAnalytics(app);
                console.log("Firebase: Firebase initialization successful.");

                console.log("Firebase Auth: Checking initial authentication token...");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        console.log("Firebase Auth: Attempting to sign in with custom token.");
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Firebase Auth: Successfully signed in with custom token.");
                    } catch (tokenError) {
                        console.error("Firebase Auth: Failed to sign in with custom token. Attempting anonymous. Error:", tokenError);
                        await signInAnonymously(auth);
                        console.log("Firebase Auth: Successfully signed in anonymously after custom token failure.");
                    }
                } else {
                    console.log("Firebase Auth: Custom token not found, attempting anonymous sign-in.");
                    await signInAnonymously(auth);
                    console.log("Firebase Auth: Successfully signed in anonymously.");
                }

            } catch (error) {
                console.error("Firebase: Error during initialization or sign-in:", error);
                showMessage(`Failed to initialize Firebase: ${error.message}. Account features might not work.`);
            }

            // Authentication state change listener
            onAuthStateChanged(auth, async (user) => {
                console.log("Firebase Auth State Changed. User:", user ? user.uid : "null");
                if (user) {
                    userId = user.uid;
                    authStatus.classList.remove('logged-out');
                    authStatus.classList.add('logged-in');
                    loginBtn.classList.add('hidden');
                    registerBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    emailInput.value = user.email || '';
                    emailInput.disabled = true;
                    passwordInput.value = '';
                    passwordInput.disabled = true;
                    authTitle.textContent = "Status Akun";

                    // Save basic user data to Firestore if it doesn't exist
                    // Ensure `db` and `appId` are initialized before calling Firestore
                    if (db && appId) {
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                        console.log("Firestore: Attempting to get user profile document for UID:", userId);
                        try {
                            const userDocSnap = await getDoc(userDocRef);
                            if (!userDocSnap.exists()) {
                                console.log("Firestore: User profile not found, creating a new one.");
                                await setDoc(userDocRef, {
                                    email: user.email || null,
                                    createdAt: new Date(),
                                    isPremium: false // Default non-premium
                                });
                                console.log("Firestore: User profile successfully created.");
                                isUserPremium = false; // Set premium status
                            } else {
                                console.log("Firestore: User profile already exists.");
                                isUserPremium = userDocSnap.data().isPremium || false; // Get premium status from Firestore
                            }
                        } catch (firestoreError) {
                            console.error("Firestore: Error accessing or creating user profile:", firestoreError);
                            showMessage(`Firestore Error: ${firestoreError.message}.`);
                            isUserPremium = false; // Default to non-premium if there's an error
                        }
                    } else {
                        console.warn("Firestore: Database or App ID not initialized. Cannot save user profile.");
                        isUserPremium = false; // Default to non-premium
                    }
                    updatePremiumUI(user); // Update UI after getting premium status, passing user object
                } else {
                    userId = null;
                    isUserPremium = false; // Reset premium status on logout
                    authStatus.classList.remove('logged-in');
                    authStatus.classList.add('logged-out');
                    loginBtn.classList.remove('hidden');
                    registerBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    emailInput.value = '';
                    emailInput.disabled = false;
                    passwordInput.value = '';
                    passwordInput.disabled = false;
                    authTitle.textContent = "Masuk / Daftar";
                    updatePremiumUI(null); // Update UI on logout, passing null for user
                }
            });

            // Event Listener for Register
            registerBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;

                console.log("Auth: Attempting to register with email:", email);
                if (!email || !password) {
                    showMessage('Email and password must be filled.');
                    console.warn("Auth: Empty email or password during registration.");
                    return;
                }
                if (password.length < 6) {
                    showMessage('Password must be at least 6 characters long.');
                    console.warn("Auth: Password too short during registration.");
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    console.log("Auth: Registration successful for user:", user.uid);
                    // Save basic user data to Firestore upon successful registration
                    const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                    await setDoc(userDocRef, {
                        email: user.email,
                        createdAt: new Date(),
                        isPremium: false
                    });
                    console.log("Firestore: User profile created after registration.");
                    showMessage('Registration successful! You are now logged in.');
                } catch (error) {
                    console.error("Auth: Error during registration:", error);
                    let errorMessage = "Failed to register. ";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage += "Email is already registered.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage += "Invalid email format.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage += "Password is too weak.";
                    } else {
                        errorMessage += error.message;
                    }
                    showMessage(errorMessage);
                }
            });

            // Event Listener for Login
            loginBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;

                console.log("Auth: Attempting to log in with email:", email);
                if (!email || !password) {
                    showMessage('Email and password must be filled.');
                    console.warn("Auth: Empty email or password during login.");
                    return;
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log("Auth: Login successful.");
                    showMessage('Login successful! Welcome back.');
                } catch (error) {
                    console.error("Auth: Error during login:", error);
                    let errorMessage = "Failed to log in. ";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage += "Incorrect email or password.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage += "Invalid email format.";
                    } else {
                        errorMessage += error.message;
                    }
                    showMessage(errorMessage);
                }
            });

            // Event Listener for Logout
            logoutBtn.addEventListener('click', async () => {
                console.log("Auth: Attempting to log out.");
                try {
                    await signOut(auth);
                    console.log("Auth: Successfully logged out.");
                    showMessage('You have been logged out.');
                }
                catch (error) {
                    console.error("Auth: Error during logout:", error);
                    showMessage(`Failed to log out: ${error.message}`);
                }
            });

            // Event Listener for Upgrade to Premium
            upgradePremiumBtn.addEventListener('click', async () => {
                if (!userId) {
                    showMessage('You must be logged in to upgrade to Premium.');
                    return;
                }
                if (isUserPremium) {
                    showMessage('You are already a Premium member!');
                    return;
                }

                console.log("Premium: Attempting to upgrade user to Premium for UID:", userId);
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    await updateDoc(userDocRef, {
                        isPremium: true,
                        premiumActivatedAt: new Date()
                    });
                    isUserPremium = true; // Update local premium status
                    updatePremiumUI(auth.currentUser); // Update UI, passing auth.currentUser
                    showMessage('Congratulations! Your account is now Premium!');
                    console.log("Premium: User successfully upgraded to Premium.");
                } catch (error) {
                    console.error("Premium: Error upgrading to Premium:", error);
                    showMessage(`Failed to upgrade to Premium: ${error.message}`);
                }
            });

            // Event Listener for changes in the paper length dropdown
            panjangMakalahSelect.addEventListener('change', () => {
                updatePremiumUI(auth.currentUser); // Update UI when selection changes, passing auth.currentUser
            });


            // Logic for generating the paper
            generateBtn.addEventListener('click', async () => {
                const judul = judulMakalahInput.value.trim();
                const kerangka = kerangkaMakalahTextarea.value.trim();
                const panjang = panjangMakalahSelect.value;
                let finalWordCount = 0; // To store the final requested word count

                console.log("Generator: Generate Paper button clicked.");
                if (!judul) {
                    showMessage('Please enter a paper title.');
                    console.warn("Generator: Paper title is empty.");
                    return;
                }

                // Check if user is logged in before generating paper
                if (!userId) {
                    showMessage('You must be logged in to generate a paper.');
                    console.warn("Generator: User not logged in, cannot generate paper.");
                    return;
                }
                console.log("Generator: User authenticated (UID:", userId, "). Proceeding with paper generation.");

                // Check premium features based on selected length
                const premiumLengths = ['5000_kata', 'custom_premium'];
                if (premiumLengths.includes(panjang) && !isUserPremium) {
                    showMessage('This feature is only available for Premium members. Please upgrade your account.');
                    console.warn("Generator: Non-premium user attempting to access premium feature.");
                    return;
                }

                // Determine the final requested word count
                if (panjang === 'custom_premium') {
                    const customValue = parseInt(customWordCountInput.value, 10);
                    if (isNaN(customValue) || customValue < 5000 || customValue < 5000 || customValue > 12000) {
                        showMessage('For custom length, please enter a number between 5000 and 12000.');
                        console.warn("Generator: Invalid custom word count input.");
                        return;
                    }
                    finalWordCount = customValue;
                } else if (panjang === 'pendek') {
                    finalWordCount = 500;
                } else if (panjang === 'sedang') {
                    finalWordCount = 1000;
                } else if (panjang === 'panjang') {
                    finalWordCount = 1500;
                } else if (panjang === '4000_kata') {
                    finalWordCount = 4000;
                } else if (panjang === '4250_kata') {
                    finalWordCount = 4250;
                } else if (panjang === '5000_kata') {
                    finalWordCount = 5000;
                }
                console.log("Generator: Requested word count:", finalWordCount);


                loadingIndicator.classList.add('active');
                generateBtn.disabled = true;
                resultArea.classList.add('hidden'); // Hide previous result area
                generatedOutlineContainer.classList.add('hidden'); // Hide previous outline

                try {
                    let prompt = `Buatkan draf makalah akademik berdasarkan informasi berikut:\n\n`;
                    prompt += `Judul: ${judul}\n\n`;
                    
                    if (kerangka) { // Only add outline if not empty
                        prompt += `Kerangka yang diberikan: ${kerangka}\n\n`;
                        prompt += `Ulangi kerangka yang diberikan dalam format daftar bernomor atau berpoin sederhana di bagian "**KERANGKA MAKALAH:**", dan kemudian kembangkan isinya di bagian "**ISI MAKALAH:**".\n\n`;
                    } else {
                        prompt += `Buat kerangka makalah yang relevan secara otomatis berdasarkan judul dalam format daftar bernomor atau berpoin sederhana di bagian "**KERANGKA MAKALAH:**", dan kemudian kembangkan isinya di bagian "**ISI MAKALAH:**".\n\n`;
                    }

                    prompt += `Isi makalah harus sekitar ${finalWordCount} kata.\n\n`;
                    prompt += `Gunakan format penulisan akademik yang standar dengan "Daftar Isi" di awal, diikuti oleh Bab (BAB I, BAB II, dst.) dan sub-judul.`;
                    prompt += ` Untuk setiap beberapa paragraf, sisipkan catatan kaki placeholder seperti '[1]', '[2]', dst. di akhir kalimat yang relevan.`;
                    prompt += ` Di bagian akhir makalah, setelah semua bab, sertakan bagian '**CATATAN KAKI:**' yang berisi daftar catatan kaki placeholder dan deskripsi singkatnya (misalnya, '1. Catatan kaki tentang definisi X.').`;
                    prompt += ` Setelah itu, sertakan bagian '**DAFTAR PUSTAKA:**' dengan setidaknya 3-5 entri placeholder yang relevan (misalnya, 'Nama Penulis. (Tahun). Judul Buku/Artikel. Penerbit/Jurnal.').`;
                    prompt += ` **Penting: Jangan sertakan sitasi atau referensi palsu. Jika Anda perlu menyebutkan sumber, gunakan placeholder seperti "[Sumber: Nama Penulis, Tahun]" atau "[Referensi diperlukan]".**`;
                    prompt += `\n\n**KERANGKA MAKALAH:**\n`; // Marker for outline
                    prompt += `\n**ISI MAKALAH:**\n`; // Marker for content

                    console.log("Generator: Prompt sent to Gemini:", prompt);

                    // Call Gemini API
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    // IMPORTANT: REPLACE THIS WITH YOUR OWN GOOGLE CLOUD API KEY!
                    // This API key must have access to the Generative Language API.
                    // Example: const apiKey = "AIzaSyB-YourValidAPIKeyHere";
                    const apiKey = "AIzaSyAGPK4bhFmvUNs7ZauZOtJtESevSzhbUhw"; // <<< PASTIKAN INI DIISI DENGAN API KEY GEMINI ANDA

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    console.log("Generator: Calling Gemini API at URL:", apiUrl);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Add error handling for HTTP responses
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("Generator: HTTP response error from Gemini API. Status:", response.status, "Body:", errorBody);
                        if (response.status === 401 || response.status === 403) {
                            throw new Error(`Gemini API Authorization Error (Status: ${response.status}). Ensure your Gemini API Key is valid and has correct permissions. Response: ${errorBody}`);
                        } else {
                            throw new Error(`HTTP Error from Gemini API! Status: ${response.status}, Response: ${errorBody}`);
                        }
                    }

                    const result = await response.json();
                    console.log("Generator: Gemini API Response:", result);

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        console.log("Generator: Raw text from Gemini:", rawText);
                        
                        // Separate outline, paper content, footnotes, and bibliography
                        const outlineMarker = "**KERANGKA MAKALAH:**";
                        const contentMarker = "**ISI MAKALAH:**";
                        const footnotesMarker = "**CATATAN KAKI:**";
                        const bibliographyMarker = "**DAFTAR PUSTAKA:**";

                        let outlineText = '';
                        let makalahText = '';
                        let footnotesText = '';
                        let bibliographyText = '';

                        // Split by markers
                        const parts = rawText.split(outlineMarker);
                        if (parts.length > 1) {
                            const contentAndBeyond = parts[1].split(contentMarker);
                            outlineText = contentAndBeyond[0].trim();
                            if (contentAndBeyond.length > 1) {
                                const footnotesAndBeyond = contentAndBeyond[1].split(footnotesMarker);
                                makalahText = footnotesAndBeyond[0].trim();
                                if (footnotesAndBeyond.length > 1) {
                                    const bibliographyAndBeyond = footnotesAndBeyond[1].split(bibliographyMarker);
                                    footnotesText = bibliographyAndBeyond[0].trim();
                                    if (bibliographyAndBeyond.length > 1) {
                                        bibliographyText = bibliographyAndBeyond[1].trim();
                                    }
                                }
                            }
                        } else {
                            // Fallback if markers are not found, assume entire text is content
                            makalahText = rawText;
                            outlineText = "Outline could not be automatically extracted. Please refer to the paper content.";
                            footnotesText = "Footnotes could not be automatically extracted.";
                            bibliographyText = "Bibliography could not be automatically extracted.";
                        }

                        // Format outline
                        let formattedOutline = outlineText
                            .replace(/^\d+\.\s*(.*)$/gm, '<li>$1</li>') // Numbered list items
                            .replace(/^[a-z]\.\s*(.*)$/gm, '<li>$1</li>') // Lettered list items
                            .replace(/^\-\s*(.*)$/gm, '<li>$1</li>'); // Bullet list items
                        
                        if (formattedOutline.includes('<li>')) {
                            // Crude way to handle nested lists, might need more robust parsing for complex outlines
                            formattedOutline = `<ul>${formattedOutline}</ul>`;
                            formattedOutline = formattedOutline.replace(/<\/li>\s*<li>/g, '</li><li>'); // Clean up extra spaces
                            formattedOutline = formattedOutline.replace(/<li>\s*([a-z]\.)/g, '<ul><li>$1'); // Basic nested list for a. b.
                            formattedOutline = formattedOutline.replace(/(<\/li>)(?!.*<li>)/g, '</li></ul>'); // Close nested lists
                        } else {
                            formattedOutline = `<p>${outlineText}</p>`; // If no list, display as paragraph
                        }

                        outlineContentDiv.innerHTML = formattedOutline;
                        generatedOutlineContainer.classList.remove('hidden');

                        // --- Start building formatted makalah content with improved structure ---
                        let finalMakalahHtml = '';
                        let tocHtml = '<h2 class="section-heading">Daftar Isi</h2><ul class="list-unstyled">';

                        // Function to generate a unique ID for headings for TOC linking
                        function generateId(text) {
                            return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-*|-*$/g, '');
                        }

                        const makalahLines = makalahText.split('\n');
                        let currentLevel = 0; // 0: root, 1: BAB, 2: A., 3: 1., 4: a.
                        let tocStack = [tocHtml]; // Stack to manage nested TOC lists

                        makalahLines.forEach(line => {
                            line = line.trim();
                            if (!line) {
                                finalMakalahHtml += `<p class="mb-4"></p>`; // Add empty paragraph for spacing
                                return; // Skip empty lines
                            }

                            // Check for BAB headings (e.g., BAB I: Pendahuluan)
                            if (line.match(/^BAB\s[IVXLCDM]+\s*:/i)) {
                                const headingId = generateId(line);
                                finalMakalahHtml += `<h2 class="bab-heading" id="${headingId}">${line}</h2>`;
                                
                                // Close previous lists if any
                                while (tocStack.length > 1) {
                                    tocHtml += tocStack.pop() + '</ul>';
                                }
                                tocHtml += `<li><a href="#${headingId}">${line}</a></li>`; // Removed page numbers placeholder
                                currentLevel = 1;
                            }
                            // Check for A. B. C. headings
                            else if (line.match(/^[A-Z]\.\s/)) {
                                const headingId = generateId(line);
                                // Add text-center to these headings
                                finalMakalahHtml += `<h3 class="text-2xl font-semibold mt-6 mb-3 text-center" id="${headingId}">${line}</h3>`;
                                
                                // Adjust TOC nesting
                                if (currentLevel < 2) { // If coming from BAB or root, start new UL
                                    tocHtml += `<ul class="list-unstyled ml-6">`;
                                    tocStack.push('</ul>'); // Push closing tag
                                } else if (currentLevel > 2) { // If coming from lower level, close previous ULs
                                    while (currentLevel > 2 && tocStack.length > 1) {
                                        tocHtml += tocStack.pop() + '</ul>';
                                    }
                                }
                                tocHtml += `<li><a href="#${headingId}">${line}</a></li>`;
                                currentLevel = 2;
                            }
                            // Check for 1. 2. 3. headings
                            else if (line.match(/^\d+\.\s/)) {
                                const headingId = generateId(line);
                                // Add text-center to these headings
                                finalMakalahHtml += `<h4 class="text-xl font-semibold mt-5 mb-2 text-center" id="${headingId}">${line}</h4>`;

                                // Adjust TOC nesting
                                if (currentLevel < 3) {
                                    tocHtml += `<ul class="list-unstyled ml-12">`;
                                    tocStack.push('</ul>');
                                } else if (currentLevel > 3) {
                                    while (currentLevel > 3 && tocStack.length > 1) {
                                        tocHtml += tocStack.pop() + '</ul>';
                                    }
                                }
                                tocHtml += `<li><a href="#${headingId}">${line}</a></li>`;
                                currentLevel = 3;
                            }
                            // Check for a. b. c. headings
                            else if (line.match(/^[a-z]\.\s/)) {
                                const headingId = generateId(line);
                                // Add text-center to these headings
                                finalMakalahHtml += `<h5 class="text-lg font-semibold mt-4 mb-1 text-center" id="${headingId}">${line}</h5>`;

                                // Adjust TOC nesting
                                if (currentLevel < 4) {
                                    tocHtml += `<ul class="list-unstyled ml-16">`;
                                    tocStack.push('</ul>');
                                } else if (currentLevel > 4) {
                                    while (currentLevel > 4 && tocStack.length > 1) {
                                        tocHtml += tocStack.pop() + '</ul>';
                                    }
                                }
                                tocHtml += `<li><a href="#${headingId}">${line}</a></li>`;
                                currentLevel = 4;
                            }
                            // Handle regular paragraphs and footnotes
                            else {
                                // Replace footnote placeholders with superscript links
                                let paragraph = line.replace(/\[(\d+)\]/g, (match, p1) => {
                                    const footnoteId = `footnote-${p1}`;
                                    return `<sup class="footnote-ref"><a href="#${footnoteId}">[${p1}]</a></sup>`;
                                });
                                finalMakalahHtml += `<p class="mb-4">${paragraph}</p>`; // Paragraphs are left-aligned by default CSS
                            }
                        });

                        // Close any remaining open TOC lists
                        while (tocStack.length > 0) { // Changed condition to close all
                            tocHtml += tocStack.pop();
                        }
                        
                        // Set Daftar Isi
                        makalahContentDiv.innerHTML = tocHtml;
                        
                        // Append main content
                        makalahContentDiv.innerHTML += finalMakalahHtml;

                        // Add Catatan Kaki
                        if (footnotesText) {
                            makalahContentDiv.innerHTML += `<h2 class="section-heading">Catatan Kaki</h2>`;
                            makalahContentDiv.innerHTML += `<ul class="list-unstyled">`; /* Removed text-gray-700 */
                            footnotesText.split('\n').forEach(line => {
                                if (line.trim()) {
                                    const match = line.trim().match(/^(\d+)\.\s*(.*)/);
                                    if (match) {
                                        const footnoteNum = match[1];
                                        const footnoteContent = match[2];
                                        makalahContentDiv.innerHTML += `<li id="footnote-${footnoteNum}">${footnoteNum}. ${footnoteContent}</li>`;
                                    } else {
                                        makalahContentDiv.innerHTML += `<li>${line.trim()}</li>`;
                                    }
                                }
                            });
                            makalahContentDiv.innerHTML += `</ul>`;
                        }

                        // Add Daftar Pustaka
                        if (bibliographyText) {
                            makalahContentDiv.innerHTML += `<h2 class="section-heading">Daftar Pustaka</h2>`;
                            makalahContentDiv.innerHTML += `<ul class="list-unstyled">`; /* Removed text-gray-700 */
                            bibliographyText.split('\n').forEach(line => {
                                if (line.trim()) {
                                    makalahContentDiv.innerHTML += `<li>${line.trim()}</li>`;
                                }
                            });
                            bibliographyText += `</ul>`;
                        }


                        resultArea.classList.remove('hidden'); // Show result area
                        console.log("Generator: Paper successfully displayed.");
                    } else {
                        showMessage('Failed to generate paper. Please try again. Unexpected API response.');
                        console.error('Generator: Unexpected API response structure:', result);
                    }
                } catch (error) {
                    showMessage(`An error occurred: ${error.message}. Please check the console for details.`);
                    console.error('Generator: Error generating paper content:', error);
                } finally {
                    loadingIndicator.classList.remove('active');
                    generateBtn.disabled = false;
                    console.log("Generator: Paper generation process completed.");
                }
            });

            copyContentBtn.addEventListener('click', () => {
                console.log("Copy: Copy Content button clicked.");
                let fullTextToCopy = '';

                // 1. Copy Generated Outline (if visible)
                if (!generatedOutlineContainer.classList.contains('hidden')) {
                    fullTextToCopy += 'GENERATED OUTLINE:\n\n';
                    const outlineElements = outlineContentDiv.querySelectorAll('ul, li, p');
                    outlineElements.forEach(el => {
                        if (el.tagName === 'LI') {
                            let prefix = '';
                            let parentUl = el.closest('ul');
                            if (parentUl) {
                                let listStyle = window.getComputedStyle(parentUl).listStyleType;
                                if (listStyle === 'decimal') {
                                    prefix = `${Array.from(parentUl.children).indexOf(el) + 1}. `;
                                } else if (listStyle === 'lower-alpha') {
                                    prefix = `${String.fromCharCode(97 + Array.from(parentUl.children).indexOf(el))}. `;
                                } else {
                                    prefix = '- '; // Default for disc, square, etc.
                                }
                            } else {
                                prefix = '- '; // Fallback if not in a list
                            }
                            fullTextToCopy += `${prefix}${el.textContent.trim()}\n`;
                        } else if (el.tagName === 'P') {
                            fullTextToCopy += `${el.textContent.trim()}\n`;
                        }
                    });
                    fullTextToCopy += '\n';
                }

                // 2. Copy Main Paper Content (including Table of Contents, Chapters, sub-headings, paragraphs, lists, footnotes, bibliography)
                // Reconstruct from makalahContentDiv's innerHTML based on new structure
                const elements = makalahContentDiv.children;
                Array.from(elements).forEach(el => {
                    if (el.classList.contains('section-heading') || el.classList.contains('bab-heading')) {
                        fullTextToCopy += `\n${el.textContent.trim().toUpperCase()}\n\n`;
                    } else if (el.tagName === 'P') {
                        fullTextToCopy += `${el.textContent.trim()}\n\n`;
                    } else if (el.tagName === 'UL') {
                        // Handle nested lists for TOC or regular lists
                        const listItems = el.querySelectorAll('li');
                        listItems.forEach(li => {
                            let indent = '';
                            let currentParent = li.parentElement;
                            while (currentParent && currentParent.tagName === 'UL' && currentParent !== el) {
                                indent += '  '; // Add two spaces for each level of nesting
                                currentParent = currentParent.parentElement;
                            }

                            let prefix = '- '; // Default bullet
                            let listStyle = window.getComputedStyle(li.parentElement).listStyleType;
                            if (listStyle === 'decimal') {
                                prefix = `${Array.from(li.parentElement.children).indexOf(li) + 1}. `;
                            } else if (listStyle === 'lower-alpha') {
                                prefix = `${String.fromCharCode(97 + Array.from(li.parentElement.children).indexOf(li))}. `;
                            } else if (listStyle === 'lower-roman') {
                                // Basic roman numeral for display, not actual conversion
                                prefix = `${Array.from(li.parentElement.children).indexOf(li) + 1}. `; // Fallback to number for copy
                            }

                            fullTextToCopy += `${indent}${prefix}${li.textContent.trim()}\n`;
                        });
                        fullTextToCopy += '\n'; // Add a newline after each list
                    } else if (el.tagName === 'H3' || el.tagName === 'H4' || el.tagName === 'H5') {
                        fullTextToCopy += `\n${el.textContent.trim()}\n\n`;
                    }
                });


                console.log("Copy: Text to be copied:", fullTextToCopy);

                // Use a temporary textarea to copy the formatted text
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = fullTextToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                tempTextArea.setSelectionRange(0, 99999); // For mobile devices

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showMessage('Paper content (outline & body) successfully copied!');
                        console.log("Copy: Content successfully copied.");
                    } else {
                        showMessage('Failed to copy content. Please copy manually.');
                        console.warn("Copy: Failed to copy content using execCommand.");
                    }
                } catch (err) {
                    showMessage('Failed to copy content. Please copy manually.');
                    console.error('Copy: Error copying text:', err);
                } finally {
                    document.body.removeChild(tempTextArea);
                    console.log("Copy: Temporary textarea removed.");
                }
            });
        });
    </script>
</body>
</html>
